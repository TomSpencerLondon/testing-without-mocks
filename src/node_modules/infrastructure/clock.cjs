// Copyright Titanium I.T. LLC.
"use strict";

const FakeTimers = require("@sinonjs/fake-timers");
const ensure = require("util/ensure");
const EventEmitter = require("events");

const NOT_A_NULLED_CLOCK_MESSAGE = "Can't advance the clock because it isn't a nulled clock";

/** Wrapper for system clock */
module.exports = class Clock {

	static create() {
		ensure.signature(arguments, []);

		return new Clock({
			Date,
			DateTimeFormat: Intl.DateTimeFormat,
			setTimeout,
			clearTimeout,
			advanceNulledClockAsync() { throw new Error(NOT_A_NULLED_CLOCK_MESSAGE); },
			advanceNulledClockUntilTimersExpireAsync() { throw new Error(NOT_A_NULLED_CLOCK_MESSAGE); }
		});
	}

	static createNull(options) {
		return new Clock(stubbedGlobals(options));
	}

	constructor(globals) {
		ensure.signature(arguments, [ Object ]);

		this._globals = globals;
		this._emitter = new EventEmitter();
	}

	now() {
		ensure.signature(arguments, []);

		return this._globals.Date.now();
	}

	toFormattedString(intlDateTimeFormatOptions, locale) {
		if (intlDateTimeFormatOptions?.timeZone === undefined) {
			throw new Error("Must specify options.timeZone (use 'local' for computer's time zone)");
		}
		if (locale === undefined) {
			throw new Error("Must specify locale (use 'local' for computer's default locale)");
		}
		ensure.signature(arguments, [ Object, String ]);

		const options = { ...intlDateTimeFormatOptions };
		if (options.timeZone === "local") delete options.timeZone;
		if (locale === "local") locale = undefined;

		const now = new this._globals.Date();
		const formatter = this._globals.DateTimeFormat(locale, options);
		return formatter.format(now);
	}

	async advanceNulledClockAsync(milliseconds) {
		ensure.signature(arguments, [ Number ]);

		await this._globals.advanceNulledClockAsync(milliseconds);
	}

	async advanceNulledClockUntilTimersExpireAsync() {
		ensure.signature(arguments, []);

		await this._globals.advanceNulledClockUntilTimersExpireAsync();
	}

	async waitAsync(milliseconds) {
		ensure.signature(arguments, [ Number ]);

		await new Promise((resolve) => {
			this._globals.setTimeout(resolve, milliseconds);
		});
	}

	async timeoutAsync(milliseconds, promiseToWaitFor, timeoutFnAsync) {
		ensure.signature(arguments, [ Number, Promise, Function ]);

		return await new Promise(async (resolve, reject) => {
			const cancelToken = this._globals.setTimeout(async () => {
				try {
					const result = await timeoutFnAsync();
					resolve(result);
				}
				catch (err) {
					reject(err);
				}
			}, milliseconds);

			try {
				const result = await promiseToWaitFor;
				resolve(result);
			}
			catch (err) {
				reject(err);
			}
			finally {
				this._globals.clearTimeout(cancelToken);
			}
		});
	}

};


function stubbedGlobals({
	now = 0,
	locale = "gv-GB",
	timeZone = "Australia/Lord_Howe"
} = {}) {
	ensure.signature(arguments, [[ undefined, {
		now: [ undefined, Number ],
		locale: [ undefined, String ],
		timeZone: [ undefined, String ],
	}]]);

	const fake = FakeTimers.createClock(now);

	return {
		Date: fake.Date,

		DateTimeFormat(locales, options) {
			if (locales === undefined) locales = locale;
			options = { timeZone, ...options };
			return Intl.DateTimeFormat(locales, options);
		},

		async advanceNulledClockAsync(milliseconds) {
			await fake.tickAsync(milliseconds);
		},

		async advanceNulledClockUntilTimersExpireAsync() {
			await fake.runAllAsync();
		},

		setTimeout(fn, milliseconds) {
			return fake.setTimeout(fn, milliseconds);
		},

		clearTimeout(fn, milliseconds) {
			return fake.clearTimeout(fn, milliseconds);
		},
	};

}