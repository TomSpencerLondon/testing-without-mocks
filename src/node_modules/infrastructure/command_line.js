// Copyright Titanium I.T. LLC.
import * as ensure from "util/ensure.js";
import { OutputListener } from "util/output_listener.js";

/** Wrapper for command-line processing */
export class CommandLine {

	static create() {
		ensure.signature(arguments, []);
		return new CommandLine(process);
	}

	static createNull({ args = [] } = {}) {
		ensure.signature(arguments, [ [ undefined, { args: Array } ] ]);
		return new CommandLine(new StubbedProcess(args));
	}

	constructor(proc) {
		this._process = proc;
		this._stdoutListener = new OutputListener();
		this._stderrListener = new OutputListener();
	}

	args() {
		ensure.signature(arguments, []);
		return this._process.argv.slice(2);
	}

	writeStdout(text) {
		ensure.signature(arguments, [ String ]);
		this._process.stdout.write(text);
		this._stdoutListener.emit(text);
	}

	writeStderr(text) {
		ensure.signature(arguments, [ String ]);
		this._process.stderr.write(text);
		this._stderrListener.emit(text);
	}

	trackStdout() {
		return this._stdoutListener.trackOutput();
	}

	trackStderr() {
		return this._stderrListener.trackOutput();
	}

}


class StubbedProcess {

	constructor(args) {
		this._args = args;
	}

	get argv() {
		return [ "stubbed_process_node", "stubbed_process_script.js", ...this._args ];
	}

	get stdout() {
		return {
			write() {},
		};
	}

	get stderr() {
		return {
			write() {},
		};
	}

}